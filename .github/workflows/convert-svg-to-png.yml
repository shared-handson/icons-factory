name: Convert SVG to PNG

on:
  push:
    branches: [main]
    paths:
      - "*/*.svg"
  workflow_dispatch:

jobs:
  convert-svg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y inkscape

      - name: Convert SVG to PNG
        run: |
          # å…±é€šã®é™¤å¤–ãƒ•ã‚©ãƒ«ãƒ€è¨­å®šï¼ˆgenerate-icon-listã¨çµ±ä¸€ï¼‰
          EXCLUDE_FOLDERS=".git .github template"
          converted_files=0
          deleted_svgs=0

          # å…±é€šã®ãƒ•ã‚©ãƒ«ãƒ€é™¤å¤–åˆ¤å®šé–¢æ•°
          should_skip_folder() {
            local folder_name="$1"
            for exclude in $EXCLUDE_FOLDERS; do
              if [ "$folder_name" = "$exclude" ]; then
                return 0  # skip
              fi
            done
            return 1  # process
          }

          # SVGãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¤œç´¢
          for folder in */; do
            if [ -d "$folder" ]; then
              folder_name=$(basename "$folder")
              
              # é™¤å¤–ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¹ã‚­ãƒƒãƒ—
              if should_skip_folder "$folder_name"; then
                continue
              fi
              
              # SVGãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              if ls "$folder"*.svg 1> /dev/null 2>&1; then
                echo "Converting SVGs in: $folder_name"
                cd "$folder"
                
                for svg_file in *.svg; do
                  if [ -f "$svg_file" ]; then
                    # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰PNGåã‚’ç”Ÿæˆï¼ˆæ‹¡å¼µå­ã‚’å¤‰æ›´ï¼‰
                    png_file="${svg_file%.svg}.png"
                    
                    echo "Converting: $svg_file -> $png_file"
                    
                    # Inkscapeã‚’ä½¿ç”¨ã—ã¦SVGã‚’PNGã«å¤‰æ›ï¼ˆ512x512pxï¼‰
                    inkscape --export-type=png \
                             --export-width=512 \
                             --export-height=512 \
                             --export-filename="$png_file" \
                             "$svg_file"
                    
                    if [ $? -eq 0 ]; then
                      echo "âœ… Successfully converted: $svg_file"
                      converted_files=$((converted_files + 1))
                      
                      # å¤‰æ›æˆåŠŸå¾Œã«SVGãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
                      rm "$svg_file"
                      if [ $? -eq 0 ]; then
                        echo "ğŸ—‘ï¸  Deleted original SVG: $svg_file"
                        deleted_svgs=$((deleted_svgs + 1))
                      else
                        echo "âš ï¸  Failed to delete SVG: $svg_file"
                      fi
                    else
                      echo "âŒ Failed to convert: $svg_file"
                    fi
                  fi
                done
                
                cd ..
              fi
            fi
          done

          echo "ğŸ“Š Conversion Summary:"
          echo "   - Total files converted: $converted_files"
          echo "   - Total SVGs deleted: $deleted_svgs"

      - name: Commit converted PNG files and removed SVGs
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ–°ã—ã„PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add */*.png
          
          # å‰Šé™¤ã•ã‚ŒãŸSVGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add -u */
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Convert SVG to PNG and cleanup SVG files [skip ci]"
            git push
            echo "âœ… Committed PNG files and removed SVG sources"
          fi

      - name: Trigger icon list generation
        if: success()
        run: |
          # ã‚¢ã‚¤ã‚³ãƒ³ãƒªã‚¹ãƒˆç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/generate-icon-list.yml/dispatches \
            -d '{"ref":"main"}'