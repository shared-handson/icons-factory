name: Generate Icon Lists

on:
  push:
    branches: [main]
    paths:
      - "*/*.png"
  workflow_dispatch:

jobs:
  generate-lists:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate icon lists for all folders
        run: |
          # 共通の除外フォルダ設定（convert-svg-to-pngと統一）
          EXCLUDE_FOLDERS=".git .github template"

          # 共通のフォルダ除外判定関数
          should_skip_folder() {
            local folder_name="$1"
            for exclude in $EXCLUDE_FOLDERS; do
              if [ "$folder_name" = "$exclude" ]; then
                return 0  # skip
              fi
            done
            return 1  # process
          }

          # PNGファイルを含むフォルダを自動検出
          for folder in */; do
            if [ -d "$folder" ]; then
              folder_name=$(basename "$folder")
              
              # 除外フォルダをスキップ
              if should_skip_folder "$folder_name"; then
                continue
              fi
              
              # PNGファイルが存在するかチェック（SVGは変換済みのためPNGのみ対象）
              if ls "$folder"*.png 1> /dev/null 2>&1; then
                echo "Generating icon list for: $folder_name"
                cd "$folder"
                
                echo '{"icons":[' > icons.json
                
                # PNGファイルを処理
                for file in *.png; do
                  if [ -f "$file" ]; then
                    echo "  \"$file\"," >> icons.json
                  fi
                done
                
                # 最後のカンマを削除
                sed -i '$ s/,$//' icons.json
                echo ']}' >> icons.json
                
                icon_count=$(cat icons.json | jq -r '.icons | length' 2>/dev/null || echo "unknown")
                echo "Generated $folder_name icons list: $icon_count icons"
                
                cd ..
              else
                echo "No PNG files found in: $folder_name"
              fi
            fi
          done

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add */icons.json
          git diff --staged --quiet || git commit -m "🤖 Update icon lists [skip ci]"
          git push
