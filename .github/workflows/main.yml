name: Build and Deploy Icons Factory

on:
  push:
    branches: [main]
  workflow_dispatch:

# GitHub Pagesã«å¿…è¦ãªæ¨©é™è¨­å®š
permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

# åŒã˜ç¨®é¡ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè¤‡æ•°å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’é˜²ã
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  EXCLUDE_FOLDERS: ".git .github template"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y inkscape bc jq imagemagick

      - name: Setup common functions
        run: |
          # å…±é€šé–¢æ•°ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          cat << 'EOF' > /tmp/common_functions.sh
          # å…±é€šã®ãƒ•ã‚©ãƒ«ãƒ€é™¤å¤–åˆ¤å®šé–¢æ•°
          should_skip_folder() {
            local folder_name="$1"
            for exclude in $EXCLUDE_FOLDERS; do
              if [ "$folder_name" = "$exclude" ]; then
                return 0  # skip
              fi
            done
            return 1  # process
          }

          # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’URLå®‰å…¨ãªå½¢å¼ã«ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã™ã‚‹é–¢æ•°
          sanitize_filename() {
            local filename="$1"
            local base_name="${filename%.*}"
            local extension="${filename##*.}"
            
            # 1. ã‚¹ãƒšãƒ¼ã‚¹ã‚’ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã«å¤‰æ›
            base_name=$(echo "$base_name" | tr ' ' '_')
            
            # 2. URLå®‰å…¨ã§ãªã„æ–‡å­—ã‚’ãƒã‚¤ãƒ•ãƒ³ã«å¤‰æ›
            base_name=$(echo "$base_name" | sed 's/[^a-zA-Z0-9_-]/-/g')
            
            # 3. é€£ç¶šã™ã‚‹ãƒã‚¤ãƒ•ãƒ³ã‚„ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã‚’å˜ä¸€ã«å¤‰æ›
            base_name=$(echo "$base_name" | sed 's/[-_]\+/-/g')
            
            # 4. å…ˆé ­ã¨æœ«å°¾ã®ãƒã‚¤ãƒ•ãƒ³ã‚’å‰Šé™¤
            base_name=$(echo "$base_name" | sed 's/^-\+//g' | sed 's/-\+$//g')
            
            # 5. ç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåã‚’ä½¿ç”¨
            if [ -z "$base_name" ]; then
              base_name="icon"
            fi
            
            echo "${base_name}.${extension}"
          }

          # ãƒ•ã‚©ãƒ«ãƒ€å‡¦ç†ã®å…±é€šãƒ‘ã‚¿ãƒ¼ãƒ³
          process_folders() {
            local file_pattern="$1"
            local process_callback="$2"
            
            for folder in */; do
              if [ -d "$folder" ]; then
                folder_name=$(basename "$folder")
                
                # é™¤å¤–ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¹ã‚­ãƒƒãƒ—
                if should_skip_folder "$folder_name"; then
                  continue
                fi
                
                # æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if ls $folder$file_pattern 1> /dev/null 2>&1; then
                  echo "Processing $file_pattern files in: $folder_name"
                  cd "$folder"
                  $process_callback
                  cd ..
                fi
              fi
            done
          }
          EOF

      - name: Convert SVG to PNG
        run: |
          # å…±é€šé–¢æ•°ã‚’èª­ã¿è¾¼ã¿
          source /tmp/common_functions.sh
          converted_files=0
          deleted_svgs=0

          # SVGå‡¦ç†é–¢æ•°ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«åã§å‡¦ç†ï¼‰
          process_svg_files() {
            for svg_file in *.svg; do
              if [ -f "$svg_file" ]; then
                # ã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ¸ˆã¿ãªã®ã§ãã®ã¾ã¾PNGåã‚’ç”Ÿæˆ
                png_file="${svg_file%.svg}.png"
                
                echo "Converting: $svg_file -> $png_file"
                
                # Inkscapeã‚’ä½¿ç”¨ã—ã¦SVGã‚’PNGã«å¤‰æ›ï¼ˆé•·è¾º512pxãƒ»ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒï¼‰
                # SVGã®å¯¸æ³•ã‚’å–å¾—
                svg_info=$(inkscape --query-all "$svg_file" | head -1)
                width=$(echo "$svg_info" | cut -d',' -f4)
                height=$(echo "$svg_info" | cut -d',' -f5)
                
                # é•·è¾ºã‚’512pxã«çµ±ä¸€ï¼ˆæ‹¡å¤§ç¸®å°å•ã‚ãšï¼‰
                if (( $(echo "$width > $height" | bc -l) )); then
                  # å¹…ãŒé•·ã„å ´åˆã€å¹…ã‚’512pxã«
                  inkscape --export-type=png \
                           --export-width=512 \
                           --export-area-page \
                           --export-background-opacity=0 \
                           --export-filename="$png_file" \
                           "$svg_file"
                else
                  # é«˜ã•ãŒé•·ã„å ´åˆã€é«˜ã•ã‚’512pxã«
                  inkscape --export-type=png \
                           --export-height=512 \
                           --export-area-page \
                           --export-background-opacity=0 \
                           --export-filename="$png_file" \
                           "$svg_file"
                fi
                
                if [ $? -eq 0 ]; then
                  echo "âœ… Successfully converted: $svg_file"
                  converted_files=$((converted_files + 1))
                  
                  # å¤‰æ›æˆåŠŸå¾Œã«SVGãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
                  rm "$svg_file"
                  if [ $? -eq 0 ]; then
                    echo "ğŸ—‘ï¸  Deleted original SVG: $svg_file"
                    deleted_svgs=$((deleted_svgs + 1))
                  else
                    echo "âš ï¸  Failed to delete SVG: $svg_file"
                  fi
                else
                  echo "âŒ Failed to convert: $svg_file"
                fi
              fi
            done
          }

          # SVGãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†å®Ÿè¡Œ
          process_folders "*.svg" "process_svg_files"

          echo "ğŸ“Š SVG Conversion Summary:"
          echo "   - Total files converted: $converted_files"
          echo "   - Total SVGs deleted: $deleted_svgs"

      - name: Sanitize image filenames
        run: |
          # å…±é€šé–¢æ•°ã‚’èª­ã¿è¾¼ã¿
          source /tmp/common_functions.sh
          sanitized_files=0

          # ãƒ•ã‚¡ã‚¤ãƒ«åã‚µãƒ‹ã‚¿ã‚¤ã‚ºå‡¦ç†é–¢æ•°
          sanitize_image_filenames() {
            local folder_sanitized=0
            # å„æ‹¡å¼µå­ã‚’å€‹åˆ¥ã«å‡¦ç†ã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«åã«å¯¾å¿œ
            for extension in jpg jpeg gif svg; do
              for img_file in *.$extension; do
                if [ -f "$img_file" ]; then
                  # ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                  sanitized_name=$(sanitize_filename "$img_file")
                  
                  # ãƒ•ã‚¡ã‚¤ãƒ«åãŒå¤‰æ›´ã•ã‚Œã‚‹å ´åˆã¯ãƒªãƒãƒ¼ãƒ 
                  if [ "$img_file" != "$sanitized_name" ]; then
                    echo "ğŸ”§ Sanitizing filename: $img_file -> $sanitized_name"
                    mv "$img_file" "$sanitized_name"
                    if [ $? -eq 0 ]; then
                      echo "âœ… Successfully renamed: $img_file"
                      folder_sanitized=$((folder_sanitized + 1))
                    else
                      echo "âŒ Failed to rename: $img_file"
                    fi
                  fi
                fi
              done
            done
            echo "Sanitized $folder_sanitized files in this folder"
          }

          # ãƒ•ã‚¡ã‚¤ãƒ«åã‚µãƒ‹ã‚¿ã‚¤ã‚ºå‡¦ç†å®Ÿè¡Œ
          for folder in */; do
            if [ -d "$folder" ]; then
              folder_name=$(basename "$folder")
              
              # é™¤å¤–ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¹ã‚­ãƒƒãƒ—
              if should_skip_folder "$folder_name"; then
                continue
              fi
              
              # å¯¾è±¡ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              if find "$folder" -maxdepth 1 \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" \) -type f | grep -q .; then
                echo "Sanitizing filenames in: $folder_name"
                cd "$folder"
                sanitize_image_filenames
                cd ..
              fi
            fi
          done

          echo "ğŸ“Š Filename Sanitization Summary:"
          echo "   - Total files sanitized: $sanitized_files"

      - name: Convert other image formats to PNG
        run: |
          # å…±é€šé–¢æ•°ã‚’èª­ã¿è¾¼ã¿
          source /tmp/common_functions.sh
          converted_files=0
          deleted_images=0

          # ãã®ä»–ç”»åƒå‡¦ç†é–¢æ•°ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«åã§å‡¦ç†ï¼‰
          process_other_images() {
            for img_file in *.jpg *.jpeg *.gif; do
              if [ -f "$img_file" ]; then
                # ã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ¸ˆã¿ãªã®ã§ãã®ã¾ã¾PNGåã‚’ç”Ÿæˆ
                png_file="${img_file%.*}.png"
                
                echo "Converting: $img_file -> $png_file"
                
                # ImageMagickã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‚’PNGã«å¤‰æ›ï¼ˆé•·è¾º512pxãƒ»ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒï¼‰
                convert "$img_file" \
                        -resize 512x512\> \
                        -background transparent \
                        "$png_file"
                
                if [ $? -eq 0 ]; then
                  echo "âœ… Successfully converted: $img_file"
                  converted_files=$((converted_files + 1))
                  
                  # å¤‰æ›æˆåŠŸå¾Œã«å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
                  rm "$img_file"
                  if [ $? -eq 0 ]; then
                    echo "ğŸ—‘ï¸  Deleted original image: $img_file"
                    deleted_images=$((deleted_images + 1))
                  else
                    echo "âš ï¸  Failed to delete image: $img_file"
                  fi
                else
                  echo "âŒ Failed to convert: $img_file"
                fi
              fi
            done
          }

          # ãã®ä»–ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†å®Ÿè¡Œï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
          for folder in */; do
            if [ -d "$folder" ]; then
              folder_name=$(basename "$folder")
              
              # é™¤å¤–ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¹ã‚­ãƒƒãƒ—
              if should_skip_folder "$folder_name"; then
                continue
              fi
              
              # å¯¾è±¡ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              if ls "$folder"*.jpg "$folder"*.jpeg "$folder"*.gif 1> /dev/null 2>&1; then
                echo "Processing other image files in: $folder_name"
                cd "$folder"
                process_other_images
                cd ..
              fi
            fi
          done

          echo "ğŸ“Š Image Conversion Summary:"
          echo "   - Total files converted: $converted_files"
          echo "   - Total images deleted: $deleted_images"

      - name: Optimize PNG files
        run: |
          # å…±é€šé–¢æ•°ã‚’èª­ã¿è¾¼ã¿
          source /tmp/common_functions.sh
          optimized_files=0

          # PNGæœ€é©åŒ–å‡¦ç†é–¢æ•°ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«åã§å‡¦ç†ï¼‰
          process_png_optimization() {
            for png_file in *.png; do
              if [ -f "$png_file" ]; then
                
                # ç”»åƒã®å¯¸æ³•ã‚’å–å¾—
                dimensions=$(identify -format "%wx%h" "$png_file" 2>/dev/null)
                if [ $? -eq 0 ]; then
                  width=$(echo "$dimensions" | cut -d'x' -f1)
                  height=$(echo "$dimensions" | cut -d'x' -f2)
                  
                  # é•·è¾ºãŒ512pxã‚’è¶…ãˆã‚‹å ´åˆã¯ç¸®å°
                  max_dimension=$(( width > height ? width : height ))
                  if [ "$max_dimension" -gt 512 ]; then
                    echo "ğŸ“ Resizing: $png_file (${width}x${height} -> max 512px)"
                    
                    if [ "$width" -gt "$height" ]; then
                      # å¹…ãŒé•·ã„å ´åˆã€å¹…ã‚’512pxã«
                      convert "$png_file" -resize 512x "$png_file"
                    else
                      # é«˜ã•ãŒé•·ã„å ´åˆã€é«˜ã•ã‚’512pxã«
                      convert "$png_file" -resize x512 "$png_file"
                    fi
                    
                    if [ $? -eq 0 ]; then
                      echo "âœ… Successfully resized: $png_file"
                      optimized_files=$((optimized_files + 1))
                    else
                      echo "âŒ Failed to resize: $png_file"
                    fi
                  else
                    echo "âœ… PNG already optimal size: $png_file (${width}x${height})"
                  fi
                else
                  echo "âš ï¸  Could not get dimensions for: $png_file"
                fi
              fi
            done
          }

          # PNGæœ€é©åŒ–å‡¦ç†å®Ÿè¡Œ
          process_folders "*.png" "process_png_optimization"

          echo "ğŸ“Š PNG Optimization Summary:"
          echo "   - Total files optimized: $optimized_files"

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ–°ã—ã„PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add */*.png
          
          # å‰Šé™¤ã•ã‚ŒãŸå…ƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆSVG/JPG/JPEG/GIFï¼‰ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add -u */
          
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Convert images to PNG [skip ci]"
            git push
            echo "âœ… Committed all changes"
          fi

      - name: Prepare deployment files
        run: |
          # å…±é€šé–¢æ•°ã‚’èª­ã¿è¾¼ã¿
          source /tmp/common_functions.sh
          updated_files=0
          generated_json_files=0

          # templateãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ ! -f "template/index.html" ]; then
            echo "âŒ template/index.html not found"
            exit 1
          fi

          echo "ğŸ“„ Preparing deployment files..."

          # ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å‡¦ç†é–¢æ•°
          prepare_deployment_files() {
            # 1. templateã‹ã‚‰index.htmlã‚’ã‚³ãƒ”ãƒ¼ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®ã¿ï¼‰
            cp ../template/index.html index.html
            
            if [ $? -eq 0 ]; then
              echo "âœ… Prepared index.html for $folder_name"
              updated_files=$((updated_files + 1))
            else
              echo "âŒ Failed to prepare index.html for $folder_name"
              return
            fi
            
            # 2. icons.jsonã‚’ç”Ÿæˆï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®ã¿ï¼‰
            echo '{"icons":[' > icons.json
            
            # PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
            for file in *.png; do
              if [ -f "$file" ]; then
                echo "  \"$file\"," >> icons.json
              fi
            done
            
            # æœ€å¾Œã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
            sed -i '$ s/,$//' icons.json
            echo ']}' >> icons.json
            
            icon_count=$(cat icons.json | jq -r '.icons | length' 2>/dev/null || echo "unknown")
            echo "âœ… Generated icons.json for $folder_name: $icon_count icons"
            generated_json_files=$((generated_json_files + 1))
          }

          # PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€ãƒ•ã‚©ãƒ«ãƒ€ã®å‡¦ç†å®Ÿè¡Œ
          process_folders "*.png" "prepare_deployment_files"

          echo "ğŸ“Š Deployment Preparation Summary:"
          echo "   - Total index.html files prepared: $updated_files"
          echo "   - Total icons.json files generated: $generated_json_files"
          echo "   - Files ready for GitHub Pages deployment (not committed to repository)"

      - name: Generate search index
        run: |
          # å…±é€šé–¢æ•°ã‚’èª­ã¿è¾¼ã¿
          source /tmp/common_functions.sh
          total_icons=0

          echo "ğŸ” Generating search index..."

          # æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®é–‹å§‹
          echo '{"icons":[' > search-index.json

          # æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆé–¢æ•°
          generate_search_entries() {
            # å„PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«è¿½åŠ 
            for file in *.png; do
              if [ -f "$file" ]; then
                # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ‹¡å¼µå­ã‚’é™¤ã„ãŸã‚¢ã‚¤ã‚³ãƒ³åã‚’å–å¾—
                icon_name="${file%.png}"
                
                # JSONã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
                echo "  {" >> ../search-index.json
                echo "    \"name\": \"$icon_name\"," >> ../search-index.json
                echo "    \"filename\": \"$file\"," >> ../search-index.json
                echo "    \"category\": \"$folder_name\"," >> ../search-index.json
                echo "    \"path\": \"$folder_name/$file\"" >> ../search-index.json
                echo "  }," >> ../search-index.json
                
                total_icons=$((total_icons + 1))
              fi
            done
          }

          # æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆå‡¦ç†å®Ÿè¡Œ
          process_folders "*.png" "generate_search_entries"

          # æœ€å¾Œã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
          sed -i '$ s/,$//' search-index.json
          echo ']}' >> search-index.json

          echo "âœ… Generated search index with $total_icons icons across all categories"
          
          # æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å†…å®¹ã‚’æ¤œè¨¼
          if command -v jq > /dev/null 2>&1; then
            icon_count=$(cat search-index.json | jq -r '.icons | length' 2>/dev/null || echo "validation failed")
            echo "ğŸ” Search index validation: $icon_count icons indexed"
          fi

      - name: Generate metadata file
        run: |
          # å…±é€šé–¢æ•°ã‚’èª­ã¿è¾¼ã¿
          source /tmp/common_functions.sh
          
          echo "ğŸ“Š Generating metadata file..."
          
          # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®é–‹å§‹
          echo '{' > metadata.json
          echo '  "categories": {' >> metadata.json
          
          total_icons=0
          category_count=0

          # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆé–¢æ•°
          generate_metadata_entry() {
            category_icon_count=0
            
            # ã‚«ãƒ†ã‚´ãƒªå†…ã®PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            for file in *.png; do
              if [ -f "$file" ]; then
                category_icon_count=$((category_icon_count + 1))
              fi
            done
            
            if [ "$category_icon_count" -gt 0 ]; then
              if [ "$category_count" -gt 0 ]; then
                echo "," >> ../metadata.json
              fi
              
              echo "    \"$folder_name\": {" >> ../metadata.json
              echo "      \"count\": $category_icon_count," >> ../metadata.json
              echo "      \"name\": \"$(echo $folder_name | tr '[:lower:]' '[:upper:]')\"" >> ../metadata.json
              echo "    }" >> ../metadata.json
              
              total_icons=$((total_icons + category_icon_count))
              category_count=$((category_count + 1))
            fi
          }

          # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå‡¦ç†å®Ÿè¡Œ
          process_folders "*.png" "generate_metadata_entry"
          
          # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®çµ‚äº†
          echo '' >> metadata.json
          echo '  },' >> metadata.json
          echo '  "total": {' >> metadata.json
          echo "    \"icons\": $total_icons," >> metadata.json
          echo "    \"categories\": $category_count" >> metadata.json
          echo '  },' >> metadata.json
          echo "  \"generated_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" >> metadata.json
          echo '}' >> metadata.json

          echo "âœ… Generated metadata: $category_count categories, $total_icons total icons"
          
          # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’æ¤œè¨¼
          if command -v jq > /dev/null 2>&1; then
            if jq . metadata.json > /dev/null 2>&1; then
              echo "ğŸ“Š Metadata validation: Valid JSON"
            else
              echo "âŒ Metadata validation: Invalid JSON"
            fi
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4